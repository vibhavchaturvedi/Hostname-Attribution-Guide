# /etc/audit/rules.d/network.rules
# Linux Audit Rules for Network Connection Monitoring
#
# Purpose: Track network connections with process attribution
# Installation: 
#   1. Copy to /etc/audit/rules.d/network.rules
#   2. Run: augenrules --load
#   3. Verify: auditctl -l
#
# Query examples:
#   ausearch -k outbound_connection -i
#   ausearch -sc connect -i
#   aureport -n --summary

# ============================================
# Socket Creation Monitoring
# ============================================

# Monitor IPv4 socket creation (AF_INET = 2)
-a always,exit -F arch=b64 -S socket -F a0=2 -k socket_ipv4
-a always,exit -F arch=b32 -S socket -F a0=2 -k socket_ipv4

# Monitor IPv6 socket creation (AF_INET6 = 10)
-a always,exit -F arch=b64 -S socket -F a0=10 -k socket_ipv6
-a always,exit -F arch=b32 -S socket -F a0=10 -k socket_ipv6

# ============================================
# Outbound Connection Monitoring
# ============================================

# Monitor all connect() syscalls (outbound connections)
-a always,exit -F arch=b64 -S connect -k outbound_connection
-a always,exit -F arch=b32 -S connect -k outbound_connection

# ============================================
# Server/Backdoor Detection
# ============================================

# Monitor bind() - new listening sockets
-a always,exit -F arch=b64 -S bind -k bind_socket
-a always,exit -F arch=b32 -S bind -k bind_socket

# Monitor listen() - socket entering listen state
-a always,exit -F arch=b64 -S listen -k listen_socket
-a always,exit -F arch=b32 -S listen -k listen_socket

# Monitor accept() - incoming connections
-a always,exit -F arch=b64 -S accept -k accept_connection
-a always,exit -F arch=b64 -S accept4 -k accept_connection
-a always,exit -F arch=b32 -S accept -k accept_connection
-a always,exit -F arch=b32 -S accept4 -k accept_connection

# ============================================
# Optional: User-Based Filtering
# Uncomment to only track non-system users (UID >= 1000)
# ============================================

# -a always,exit -F arch=b64 -S connect -F auid>=1000 -F auid!=4294967295 -k user_outbound
# -a always,exit -F arch=b32 -S connect -F auid>=1000 -F auid!=4294967295 -k user_outbound

# ============================================
# Optional: Process Exclusions
# Uncomment and modify to exclude high-volume legitimate processes
# ============================================

# Exclude specific processes (example: monitoring agents)
# -a never,exit -F arch=b64 -S connect -F exe=/usr/bin/prometheus
# -a never,exit -F arch=b64 -S connect -F exe=/opt/datadog-agent/bin/agent

# ============================================
# DNS Monitoring (Port 53)
# More targeted approach for DNS-specific tracking
# ============================================

# Note: This requires additional parsing to filter by port
# Use eBPF tools (gethostlatency) for better DNS visibility

# ============================================
# Network Configuration Changes
# ============================================

# Monitor network configuration files
-w /etc/hosts -p wa -k hosts_file
-w /etc/resolv.conf -p wa -k dns_config
-w /etc/nsswitch.conf -p wa -k nsswitch

# Monitor network interface configuration
-w /etc/network/ -p wa -k network_config
-w /etc/sysconfig/network-scripts/ -p wa -k network_scripts

# Monitor firewall rules
-w /etc/iptables/ -p wa -k firewall_config
-w /etc/nftables.conf -p wa -k firewall_config

# ============================================
# Make configuration immutable (optional)
# Uncomment to prevent runtime changes
# ============================================

# -e 2
