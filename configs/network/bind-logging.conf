// /etc/bind/named.conf.logging
// BIND DNS Query Logging Configuration
//
// Purpose: Comprehensive DNS logging for hostname attribution
// Include in main named.conf: include "/etc/bind/named.conf.logging";

logging {
    // ============================================
    // Channel Definitions
    // ============================================
    
    // Query logging - primary channel for hostname attribution
    channel query_log {
        file "/var/log/bind/query.log" versions 10 size 100M;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    
    // Security events - failed queries, unauthorized access
    channel security_log {
        file "/var/log/bind/security.log" versions 5 size 50M;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    
    // General server operations
    channel default_log {
        file "/var/log/bind/named.log" versions 3 size 20M;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    
    // Debug channel (enable temporarily for troubleshooting)
    channel debug_log {
        file "/var/log/bind/debug.log" versions 2 size 50M;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity debug;
    };
    
    // RPZ/Response Policy Zone logging
    channel rpz_log {
        file "/var/log/bind/rpz.log" versions 5 size 50M;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    
    // Syslog channel for SIEM integration
    channel syslog_channel {
        syslog daemon;
        severity info;
        print-time yes;
        print-category yes;
        print-severity yes;
    };
    
    // ============================================
    // Category Assignments
    // ============================================
    
    // DNS queries - CRITICAL for hostname attribution
    category queries { query_log; syslog_channel; };
    
    // Security-related events
    category security { security_log; };
    
    // RPZ actions (sinkhole hits)
    category rpz { rpz_log; syslog_channel; };
    
    // Query response errors
    category query-errors { security_log; };
    
    // General categories
    category default { default_log; };
    category general { default_log; };
    category config { default_log; };
    category network { default_log; };
    
    // Resolver activity
    category resolver { default_log; };
    category cname { default_log; };
    
    // DNSSEC validation
    category dnssec { security_log; };
    
    // Zone transfers (watch for unauthorized)
    category xfer-in { security_log; };
    category xfer-out { security_log; };
    
    // Notify messages
    category notify { default_log; };
    
    // Client interactions
    category client { default_log; };
    
    // Lame server responses
    category lame-servers { default_log; };
    
    // Rate limiting
    category rate-limit { security_log; };
    
    // EDNS compliance
    category edns-disabled { default_log; };
};

// ============================================
// Options for Query Logging
// ============================================

options {
    // ... other options ...
    
    // Enable query logging (can also be done at runtime)
    querylog yes;
    
    // Log query source port (helps with NAT correlation)
    // Requires BIND 9.16+
    // query-source-log-port yes;
};

// ============================================
// Runtime Controls
// ============================================

// To enable/disable query logging at runtime:
//   rndc querylog on
//   rndc querylog off
//
// To check status:
//   rndc status | grep query

// ============================================
// Log Rotation (logrotate.d/bind)
// ============================================

// /etc/logrotate.d/bind
// /var/log/bind/*.log {
//     daily
//     rotate 14
//     compress
//     delaycompress
//     missingok
//     notifempty
//     create 640 bind bind
//     postrotate
//         /usr/sbin/rndc reopen || true
//     endscript
// }
